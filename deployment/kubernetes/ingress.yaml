apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: battlecastles-ingress
  namespace: battlecastles
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # WebSocket support
    nginx.ingress.kubernetes.io/websocket-services: "game-server"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "7200"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "7200"

    # Connection settings
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "battlecastles-affinity"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "10"

    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"

    # SSL/TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: no-referrer-when-downgrade";
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - battlecastles.game
    - www.battlecastles.game
    secretName: battlecastles-tls
  rules:
  - host: battlecastles.game
    http:
      paths:
      # WebSocket endpoint
      - path: /socket.io
        pathType: Prefix
        backend:
          service:
            name: game-server
            port:
              number: 3001
      # API endpoints
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: game-server
            port:
              number: 3001
      # Health check
      - path: /health
        pathType: Prefix
        backend:
          service:
            name: game-server
            port:
              number: 3001
  - host: www.battlecastles.game
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: game-server
            port:
              number: 3001
---
# Alternative: Using AWS Load Balancer Controller
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: battlecastles-ingress-alb
#   namespace: battlecastles
#   annotations:
#     kubernetes.io/ingress.class: alb
#     alb.ingress.kubernetes.io/scheme: internet-facing
#     alb.ingress.kubernetes.io/target-type: ip
#     alb.ingress.kubernetes.io/backend-protocol: HTTP
#     alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
#     alb.ingress.kubernetes.io/ssl-redirect: '443'
#     alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:ACCOUNT:certificate/CERT-ID
#     alb.ingress.kubernetes.io/healthcheck-path: /health
#     alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'
#     alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
#     alb.ingress.kubernetes.io/healthy-threshold-count: '2'
#     alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
# spec:
#   rules:
#   - http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: game-server
#             port:
#               number: 3001
